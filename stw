#!/usr/bin/env python

import yaml
import os
import socket
import subprocess
import json
import argparse
import uuid
import shutil
from distutils import dir_util
import sys
import json
from tempfile import mkdtemp

HOME = os.environ['HOME']

#####                 Configuration
DEST_DIR = HOME + '/.stw_tmp'
CONFIG_FILE_PATH = DEST_DIR + '/settings.json'
COMPOSE_PATH = DEST_DIR + '/docker-compose.yml'
COPY_FOLDERS = [
]
CLOUD_NETWORK_NAME = 'riotcloud_riotcloudenv'
JENKINS_URL = "http://monkey-02.greenwavereality.com:8080/view/Axon-Predict/job/axon-predict_build_release"
ARTIFACT_PATH = "/lastBuild/artifact/riot-cloud/build/docker-compose/"
ZIP_POSTFIX = "/*zip*/docker-compose.zip"
################################################

def save_config():
    config = {
        'PROJECT_PATH': PROJECT_PATH,
        'DEFAULT_ATOM_SETTINGS_FILE': DEFAULT_ATOM_SETTINGS_FILE,
        'ATOM_IMAGE_VERSION': ATOM_IMAGE_VERSION
    }
    with open(CONFIG_FILE_PATH, 'w+') as config_file:
        json.dump(config, config_file)

PROJECT_PATH_PROMPT = 'Enter path to project(enter to skip this step): '
DEFAULT_ATOM_SETTINGS_FILE_PROMPT = 'Enter atom settings file path(enter if you are not planning use atom): '

def setup_config():
    global PROJECT_PATH
    global DEFAULT_ATOM_SETTINGS_FILE
    global ATOM_IMAGE_VERSION

    print 'Setuping your configuration...'
    print ''

    PROJECT_PATH = raw_input(PROJECT_PATH_PROMPT).replace('~', HOME)
    while (PROJECT_PATH != '' and not os.path.exists(PROJECT_PATH)):
        print 'Could not find project at: ' + PROJECT_PATH
        PROJECT_PATH = raw_input(PROJECT_PATH_PROMPT).replace('~', HOME)
    DEFAULT_ATOM_SETTINGS_FILE = raw_input(DEFAULT_ATOM_SETTINGS_FILE_PROMPT).replace('~', HOME)
    while (DEFAULT_ATOM_SETTINGS_FILE != '' and not os.path.exists(DEFAULT_ATOM_SETTINGS_FILE)):
        print 'Could not find settings file at: ' + DEFAULT_ATOM_SETTINGS_FILE
        DEFAULT_ATOM_SETTINGS_FILE = raw_input(DEFAULT_ATOM_SETTINGS_FILE_PROMPT).replace('~', HOME)
    ATOM_IMAGE_VERSION = raw_input('Enter atom version(enter if you are not planning use atom): ')
    save_config()

def get_user_properties():
    global PROJECT_PATH
    global DEFAULT_ATOM_SETTINGS_FILE
    global ATOM_IMAGE_VERSION

    if not os.path.exists(DEST_DIR):
        print 'Creating worspace folder ', DEST_DIR
        dir_util.mkpath(DEST_DIR)
    if not os.path.exists(CONFIG_FILE_PATH):
        setup_config()
    with open(CONFIG_FILE_PATH) as config_file:
        config = json.load(config_file)
        PROJECT_PATH = config['PROJECT_PATH']
        DEFAULT_ATOM_SETTINGS_FILE = config['DEFAULT_ATOM_SETTINGS_FILE']
        ATOM_IMAGE_VERSION = config['ATOM_IMAGE_VERSION']
#################################################
get_user_properties()

ATOM_IMAGE = 'registry.greenwavereality.com/axon/riot-atom:' + ATOM_IMAGE_VERSION

#################################################

def project_call(command):
    print '#########################'
    print command
    print '#########################'
    return subprocess.call(command, shell = True, cwd = PROJECT_PATH)

COMPOSE_TEMPLATE = 'docker-compose -p riot-cloud {}'

def compose_command(command):
    st = COMPOSE_TEMPLATE.format(command)
    machine_ip = get_machine_ip()
    os.environ['PUBLIC_HOST'] = machine_ip
    print 'Using IP: ', machine_ip
    print st
    return subprocess.call(st, shell = True, cwd = DEST_DIR)

def index_of_first(lst, pred):
    for i,v in enumerate(lst):
        if pred(v):
            return i
    return None

def get_machine_ip():
    return [(s.connect(('8.8.8.8', 53)), s.getsockname()[0], s.close()) for s in [socket.socket(socket.AF_INET, socket.SOCK_DGRAM)]][0][1]

BUILD_PATH_TEMPLATE = PROJECT_PATH + "/riot-cloud/build/docker-compose{}"

def get_config(template=BUILD_PATH_TEMPLATE):
    config_path = template.format('/docker-compose-public.yml')
    if (not os.path.exists(config_path)):
        print 'Couldn\'t get docker-compose config'
        exit()
    return yaml.load(file(config_path, 'r'))

def clone_folders(template=BUILD_PATH_TEMPLATE):
    for folder_prefix in COPY_FOLDERS:
        origin_folder = template.format(folder_prefix)
        if not os.path.exists(origin_folder):
            print 'Couldn\'t get' + folder_prefix + ' folder'
            exit();
        dest_path = DEST_DIR + folder_prefix
        if os.path.exists(dest_path):
            shutil.rmtree(dest_path)
        shutil.copytree(origin_folder, dest_path)

key_lambda = lambda x: 'KEYCLOAK_AUTH-SERVER-URL' in x

def set_key_url(config):
    environment = config['services']['cloud']['environment']
    key_ind = index_of_first(environment, key_lambda)
    environment[key_ind] = environment[key_ind].replace('localhost', get_machine_ip())

def setup_for_mac():
    if sys.platform == 'darwin':
        sudoPassword = raw_input('Type password: ')
        command = 'ifconfig lo0 alias 172.16.250.1/24'
        p = os.system('echo %s|sudo -S %s' % (sudoPassword, command))

def prepare_cloud():
    if (not os.path.exists(PROJECT_PATH)):
        print 'Couldn\'t find project in ' + PROJECT_PATH
        exit()

    project_call('./gradlew clean --no-daemon')
    project_call('./gradlew :riot-cloud:prepareCloudDockerFiles --no-daemon')
    project_call('./gradlew buildDockerImage --no-daemon')

    shutil.copy2(BUILD_PATH_TEMPLATE.format('/.env'), DEST_DIR)

    if (ATOM_IMAGE_VERSION != ''):
        os.system('docker pull ' + ATOM_IMAGE)

    config = get_config()
    with file(COMPOSE_PATH, 'w') as compose:
        yaml.dump(config, compose, default_flow_style = False)

DOWNLOAD_PATH = DEST_DIR + "/docker-compose{}"

def download_cloud():
    setup_for_mac()
    import urllib
    import zipfile

    ZIP_PATH = DEST_DIR + '/compose.zip'
    urllib.urlretrieve (JENKINS_URL + ARTIFACT_PATH + ZIP_POSTFIX, ZIP_PATH)
    with open(ZIP_PATH) as archive:
        zip_archive = zipfile.ZipFile(archive)
        zip_archive.extractall(DEST_DIR)
        config = get_config(DOWNLOAD_PATH)
        clone_folders(DOWNLOAD_PATH)
        set_key_url(config)
        with file(COMPOSE_PATH, 'w') as compose:
            yaml.dump(config, compose, default_flow_style = False)
        shutil.rmtree(DOWNLOAD_PATH.format(''))
        os.remove(ZIP_PATH)
        compose_command('pull')

def create_settings_file(settings_folder_path, atom_settings_path):
    with open(atom_settings_path) as settings_file:
        settings = json.load(settings_file)
        if not settings.has_key('nodeId'):
            settings['nodeId'] = str(uuid.uuid4())
        if not settings['device'].has_key('deviceId'):
            settings['device']['deviceId'] = str(uuid.uuid4())
        with open(os.path.join(settings_folder_path, 'settings.json'), 'w') as output_settings_file:
            json.dump(settings, output_settings_file)

RUN_ATOM_TEMPLATE="docker run --rm --network={} -v {}:/usr/local/riot-atom/etc/riot-atom {} -d"

def run_atom(atom_settings_path):
    if not os.path.exists(atom_settings_path):
        print 'Couldn\'t find settings file: ' + atom_settings_path
        exit()

    settings_folder_path = mkdtemp(prefix = 'riot-')
    create_settings_file(settings_folder_path, atom_settings_path)
    command = RUN_ATOM_TEMPLATE.format(
        CLOUD_NETWORK_NAME,
        settings_folder_path,
        ATOM_IMAGE
    )

    os.system(command)
    shutil.rmtree(settings_folder_path)

def start_cloud():
    compose_command('up -d')

def remove_cloud():
    compose_command('down -v')

def pull_cloud():
    project_call('git pull -r')

parser = argparse.ArgumentParser()
parser.add_argument(
    '--start',
    action = 'store_true',
    help = 'For starting cloud at the begining of day. combination of remove, prepare, up'
)
parser.add_argument(
    '--use',
    action = 'store_true',
    help = 'In case of just using cloud. One command will do this so great.'
)
parser.add_argument(
    '--up',
    help = 'Up cloud env, ensure that at least one prepare was before',
    action = 'store_true'
)
parser.add_argument(
    '--build',
    help = 'Build new images from sources',
    action = 'store_true'
)
parser.add_argument(
    '--ui',
    help = 'Runs command using npm run from UI directory',
)
parser.add_argument(
    '--down',
    help = 'Remove cloud containers',
    action = 'store_true'
)
parser.add_argument(
    '--pull',
    action = 'store_true',
    help = 'Pull sources from git'
)
parser.add_argument(
    '--download',
    action='store_true',
    help='Download compose stuff from jenkins latest release'
)
parser.add_argument(
    '--atom',
    help = 'Run RIOT Atom',
    nargs = '?',
    const = DEFAULT_ATOM_SETTINGS_FILE
)

parser.add_argument(
    '--clean',
    action = 'store_true',
    help = 'Clean your machine folders including images and temp folder'
)

args = parser.parse_args()

try:
    if (args.up):
        start_cloud()
    elif (args.start):
        remove_cloud()
        prepare_cloud()
        start_cloud()
    elif (args.use):
        remove_cloud()
        download_cloud()
        start_cloud()
    elif (args.down):
        remove_cloud()
    elif (args.build):
        prepare_cloud()
    elif (args.pull):
        pull_cloud()
    elif (args.atom):
        run_atom(args.atom)
    elif (args.download):
        download_cloud()
    elif (args.clean):
        remove_cloud()
        if os.path.exists(DEST_DIR):
            print 'Removing: ' + DEST_DIR
            shutil.rmtree(DEST_DIR)
    elif (not args.ui == None):
        command = 'npm run ' + args.ui
        print command
        subprocess.call(command, shell = True, cwd = PROJECT_PATH + '/riot-ui')
except KeyboardInterrupt:
    pass
